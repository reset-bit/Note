[toc]

# 网络攻击

## XSS跨站脚本攻击

```html
<input type="text" value="<%= getParameter("keyword") %>">
<button>搜索</button>
<div>
  您搜索的关键词是：<%= getParameter("keyword") %>
</div>

<!-- 
	当浏览器请求 http://xxx/search?keyword="><script>alert('XSS');</script> 时，服务器会解析出请求参数keyword，拼接到html中返回给浏览器。
	实质：浏览器把用户的输入当成了脚本执行。
-->
<input type="text" value=""><script>alert('XSS');</script>">
<button>搜索</button>
<div>
  您搜索的关键词是："><script>alert('XSS');</script>
</div> 
```

一种注入代码攻击，攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如cookie、sessionID等，进而危害数据安全。

在处理输入时，以下内容都不可信：

1. 来自用户的UGC（用户生产内容）信息

> 自媒体UGC平台主要类型：知识分享、知识共筹型平台，如百度百科；社交型平台，如微信朋友圈；内容分享型平台，如哔哩哔哩；兴趣讨论类平台，如豆瓣；自我表达型平台，如微博等。

2. 来自第三方的链接
3. URL参数
4. POST参数
5. referer，可能来自不可信的来源

> 在http协议的请求（`request`）头里面，referer字段提供访问来源的信息。发送referer字段的场景：用户点击网页链接、发送表单、网页加载静态资源。
>
> 浏览器js引擎提供`document.referrer`属性，可以查看当前页面的引荐来源。这里采用的是正确拼写。

6. cookie，可能来自其他子域注入

XSS注入方法：

1. HTML内嵌文本中，以script标签形成注入

2. 内联javascript中，拼接数据突破了原本的限制（字符串、变量、方法名等）

3. 标签属性中恶意包含引号

4. 在标签href、src属性中，包含`javascirpt:`等可执行代码

   > `javascript:`协议：声明了URL主体是任意的`javascirpt`代码，由js解释器运行。多个语句，使用分号将这些语句分隔开。
   >
   > 作为a的href属性时，会导致不必要的`window.onbeforeunload`事件。在IE中更会导致gif动画图片停止播放。

分类：

1. 存储型（服务器端）：常见于带有用户保存数据的网站功能，如商品评论等。攻击者将恶意代码提交到目标网站**数据库**中，用户打开目标网站时，服务器端将恶意代码从数据库中取出并执行。
2. 反射型（服务器端）：常见于通过URL传递参数的功能，如网站搜索等。攻击者构造出包含恶意代码的**特殊URL**，用户打开目标网站时，混在其中的恶意代码被执行。
3. DOM型（客户端）：攻击者构造出包含恶意代码的**特殊URL**，用户打开目标网站时，**前端js**取出恶意代码并执行。

解决方法：

1. HTML转义
2. 纯前端渲染，把代码和数据分隔开。先加载一个不包含任何业务相关数据的静态HTML，之后通过ajax加载业务数据
3. 对于链接跳转，如`<a href='xxx'>`或`location,.href='xxx'`，要检验其内容，禁止以`javascript:`开头的链接
4. cookie中设置HttpOnly属性，使得通过js脚本无法读取cookie信息

> 服务器端Java EE 6.0：`cookie.setHttpOnly(true);`

5. 在使用`.innerHTML`等时，不要把不可信的数据作为HTML插入到页面中。若使用vue等前端技术栈，应避免使用`v-html`等功能

## CSRF跨站请求伪造攻击

攻击者诱导用户进入第三方网站，在第三方网站中，利用用户在被攻击网站中已经获取的凭证（cookie等），向被攻击网站发送跨站请求，冒充用户对被攻击网站执行某项操作。

特点：

1. 攻击一般发起在第三方网站，被攻击网站无法防止攻击发生
2. 攻击者不能获取到用户的登录凭证，仅仅冒用
3. 跨站请求可以使用各种方式，如图片URL、超链接

防护策略：

1. 同源检测（解析异步请求中header的`origin header`与`referer header`确定是否同源，针对origin不存在的情况需另外讨论）
2. CSRF Token（要求所有用户请求携带一个攻击者无法获取的Token，为了安全起见，存放在服务器端session中。每此页面加载时，使用js遍历整个dom树，对所有的a和form标签后加入Token）

## MITM中间人攻击

攻击者在通信双方之间，窃听甚至篡改信息。只是监听流量称为被动网络攻击，主动修改数据流称为主动网络攻击。

`Https`是`http + ssl`组成的，在保证会话安全的同时能很好的抵御中间人攻击。

